<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reventa Tracker - Sincronizado en la Nube</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Estilo b√°sico para asegurar que Tailwind funcione y centrar la app */
    body {
        font-family: 'Inter', sans-serif;
    }
    /* Estilo para ocultar el formulario mientras se carga Firebase */
    #loading-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: rgba(17, 24, 39, 0.95); /* bg-slate-900 con transparencia */
        z-index: 50; 
        display: flex; justify-content: center; align-items: center; 
        color: white; 
        font-size: 1.5rem;
    }
    .hidden { display: none !important; }

    /* Animaci√≥n simple de carga */
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #3b82f6; /* blue-500 */
      width: 40px;
      height: 40px;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-slate-900 p-6 rounded-xl text-gray-100">
  <!-- Overlay de carga -->
  <div id="loading-overlay">
    <div class="flex flex-col items-center space-y-4">
      <div class="spinner"></div>
      <p>Conectando a la Nube...</p>
    </div>
  </div>

  <div id="app" class="max-w-6xl mx-auto space-y-6 hidden"></div>
  <div id="form-container" class="max-w-6xl mx-auto hidden"></div> 

  <!-- Todo el JavaScript ahora est√° en un solo bloque 'type="module"' -->
  <script type="module">
    // =================================================================
    // 1. INCLUIR LIBRER√çAS DE FIREBASE
    // =================================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";


    // =================================================================
    // CONFIGURACI√ìN DE FIREBASE Y CONEXI√ìN
    // =================================================================
    // OBTENER CONFIGURACI√ìN DESDE EL ENTORNO (Crucial para el correcto funcionamiento)
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    let db; 
    let auth;
    let userId = 'anonymous'; 
    let COLLECTION_PATH;

    // Inicializar Firebase, autenticaci√≥n y Firestore
    async function initializeFirebase() {
        const overlay = document.getElementById('loading-overlay');
        const appEl = document.getElementById('app');
        const formEl = document.getElementById('form-container');

        try {
            if (!firebaseConfig.projectId) {
                throw new Error("Configuraci√≥n de Firebase no encontrada. ¬øEst√°s en un entorno Canvas?");
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Autenticaci√≥n an√≥nima obligatoria
            await signInAnonymously(auth);
            userId = auth.currentUser.uid;
            
            // Ruta de la colecci√≥n: /artifacts/{appId}/users/{userId}/reventa_items
            COLLECTION_PATH = `artifacts/${appId}/users/${userId}/reventa_items`;
            
            // Quita el overlay de carga y muestra la UI principal
            overlay.classList.add('hidden');
            appEl.classList.remove('hidden');
            formEl.classList.remove('hidden');

            // Iniciar la carga de productos en tiempo real
            loadProductos();

        } catch (error) {
            console.error("Error FATAL al inicializar Firebase o Autenticaci√≥n: ", error);
            overlay.innerHTML = `
                <div class="bg-red-900 border border-red-700 text-red-300 px-6 py-4 rounded-xl relative shadow-2xl">
                  <strong class="font-bold">¬°Error de Conexi√≥n!</strong>
                  <span class="block mt-1">No se pudo inicializar Firebase. Revise la consola.</span>
                  <span class="block text-sm mt-2">Error: ${error.message}</span>
                </div>
            `;
            // Aseg√∫rate de que los elementos de la app no se muestren si falla
            appEl.classList.add('hidden');
            formEl.classList.add('hidden');
        }
    }


    // =================================================================
    // ESTADO LOCAL DE LA APLICACI√ìN
    // =================================================================
    let productos = [];
    let tab = "panel";
    let editing = null;

    const emptyForm = { nombre: "", precioCompra: "", precioVenta: "", valorVenta: "", fecha: "", fechaVenta: "", notas: "" };
    let form = { ...emptyForm };
    
    // setFormField ya NO llama a render() para evitar perder el foco del input
    function setFormField(field, value) {
      form[field] = value;
    }
    
    // Funci√≥n para cambiar de pesta√±a y re-renderizar (Nueva funci√≥n clave para la navegaci√≥n)
    function setTab(newTab) {
      tab = newTab;
      // Si cambiamos a una pesta√±a que no es el panel, reseteamos/ocultamos el formulario de edici√≥n/creaci√≥n
      if (newTab !== 'panel') {
          editing = null;
          form = { ...emptyForm };
      }
      renderForm(); // Renderiza el formulario (o lo oculta si no es 'panel')
      render();     // Renderiza el contenido principal de la pesta√±a
    }


    // Normalizar precios: permite coma/punto al escribir, guarda con punto
    function normalizePrice(priceString) {
      if (!priceString) return "";
      return priceString.toString().replace(/,/g, '.').replace(/[^\d.]/g, '');
    }

    // Formatea un n√∫mero para mostrarlo con coma como separador decimal (ej. 148,10)
    const formatPriceDisplay = (priceString) => {
        const num = parseFloat(priceString);
        if (isNaN(num)) return '-';
        return num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // =================================================================
    // L√ìGICA DE CARGA Y GUARDADO (USANDO FIRESTORE)
    // =================================================================

    // Carga inicial y listener en tiempo real
    function loadProductos() {
      if (!db || !COLLECTION_PATH) return; 

      try {
        const colRef = collection(db, COLLECTION_PATH);

        // onSnapshot escucha los cambios en tiempo real
        onSnapshot(colRef, (snapshot) => {
            // Mapea los documentos de Firestore al estado local 'productos'
            productos = snapshot.docs.map(doc => ({ 
              id: doc.id, 
              ...doc.data(),
              // Aseguramos que los campos existan, ya que los nuevos productos a√∫n no tienen valor
              precioCompra: doc.data().precioCompra || "",
              precioVenta: doc.data().precioVenta || "",
              valorVenta: doc.data().valorVenta || "",
              fecha: doc.data().fecha || "",
              fechaVenta: doc.data().fechaVenta || ""
            }));

            // Re-renderiza la UI con los datos frescos de la base de datos
            renderForm();
            render();
            console.log(`Productos cargados (${productos.length}). UI actualizada.`);

        }, (error) => {
            console.error("Error al cargar productos en tiempo real: ", error);
            document.getElementById('app').innerHTML = `
                <div class="bg-red-900 border border-red-700 text-red-300 px-4 py-3 rounded relative mt-8" role="alert">
                  <strong class="font-bold">¬°Error de Permisos o Conexi√≥n!</strong>
                  <span class="block sm:inline">No se pueden leer los datos. Verifique sus Reglas de Seguridad de Firebase.</span>
                </div>
            `;
        });

      } catch (error) {
        console.error("Error al iniciar el listener de Firestore: ", error);
      }
    }

    // Guarda o actualiza un producto en Firestore
    async function saveProducto() {
      if (!db) {
         document.getElementById('form-error').innerHTML = '<div class="text-red-400 font-medium">‚ùå La base de datos no est√° conectada.</div>';
         return;
      }

      // 1. Normalizar y validar
      const precioCompraNormalizado = normalizePrice(form.precioCompra);

      const productoToSave = {
        ...form,
        precioCompra: precioCompraNormalizado,
        precioVenta: normalizePrice(form.precioVenta),
        valorVenta: normalizePrice(form.valorVenta),
      };

      if (!productoToSave.nombre || isNaN(parseFloat(precioCompraNormalizado))) {
        // Muestra error en la UI si faltan datos esenciales
        document.getElementById('form-error').innerHTML = '<div class="text-red-400 font-medium">‚ùå Debes rellenar el nombre y el precio de compra con un n√∫mero v√°lido.</div>';
        return;
      }
      
      // Limpia el mensaje de error si la validaci√≥n es exitosa
      document.getElementById('form-error').innerHTML = '';
      
      const isVendido = !!productoToSave.precioVenta;
      
      // CORRECCI√ìN CRUCIAL: Usamos serverTimestamp() importado de 'firebase/firestore'
      const dataToSave = { 
        ...productoToSave, 
        vendido: isVendido, 
        updatedAt: serverTimestamp() 
      };

      const isNew = !editing;

      try {
        if (editing) {
          // Actualizar documento existente
          const docRef = doc(db, COLLECTION_PATH, editing);
          await updateDoc(docRef, dataToSave);
        } else {
          // A√±adir nuevo documento
          await addDoc(collection(db, COLLECTION_PATH), dataToSave);
        }

        // 2. Resetear el formulario tras guardar
        form = { ...emptyForm };
        editing = null; 
        renderForm(); 
        
        // Muestra mensaje de √©xito (temporal, onSnapshot se encargar√° de refrescar la tabla)
        document.getElementById('form-error').innerHTML = `<div class="text-green-400 font-medium">‚úÖ Producto ${isNew ? 'a√±adido' : 'actualizado'} con √©xito.</div>`;
        console.log("Producto guardado con √©xito en Firestore.");

        // Elimina el mensaje de √©xito despu√©s de 3 segundos
        setTimeout(() => {
          document.getElementById('form-error').innerHTML = '';
        }, 3000);

      } catch (error) {
        console.error("Error al guardar producto en Firestore:", error);
        // Muestra error detallado en la UI
        document.getElementById('form-error').innerHTML = `<div class="text-red-400 font-medium">‚ùå Error al guardar: ${error.message}.</div>`;
      }
    }

    // Carga los datos de un producto en el formulario para editar
    function editProducto(p) {
      editing = p.id;
      // Limpiar mensaje de error/√©xito
      document.getElementById('form-error').innerHTML = '';
      
      // Usamos los datos originales del producto
      form = { 
          ...p,
          // Aseguramos que los campos num√©ricos sean cadenas para los inputs
          precioCompra: p.precioCompra.toString(),
          precioVenta: p.precioVenta.toString(),
          valorVenta: p.valorVenta.toString()
      }; 
      renderForm(); // Vuelve a dibujar el formulario con los datos a editar
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // =================================================================
    // RENDERIZADO DE LA UI
    // =================================================================

    // Renderiza el formulario de entrada/edici√≥n
    function renderForm() {
      const inputClasses = "border border-gray-700 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition bg-slate-700 text-white";
      
      // Muestra el formulario SOLO si la pesta√±a es 'panel'
      const formHTML = tab === "panel" ? `
        <div id="resale-form" class="bg-gray-800 shadow-lg rounded-xl p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-4 mb-3 transition transform hover:scale-[1.01] duration-300">
          <input class="${inputClasses}" placeholder="Producto" value="${form.nombre}" oninput="setFormField('nombre', this.value)" />
          <input class="${inputClasses}" placeholder="Precio compra (‚Ç¨)" type="text" value="${form.precioCompra}" oninput="setFormField('precioCompra', this.value)" />
          <input class="${inputClasses}" placeholder="Precio venta (‚Ç¨)" type="text" value="${form.precioVenta}" oninput="setFormField('precioVenta', this.value)" />
          <input class="${inputClasses}" placeholder="Valor venta (‚Ç¨)" type="text" value="${form.valorVenta}" oninput="setFormField('valorVenta', this.value)" />
          <input class="${inputClasses}" placeholder="Fecha compra" type="date" value="${form.fecha}" oninput="setFormField('fecha', this.value)" />
          <input class="${inputClasses}" placeholder="Fecha venta" type="date" value="${form.fechaVenta}" oninput="setFormField('fechaVenta', this.value)" />
          <input class="${inputClasses} md:col-span-2" placeholder="Notas" value="${form.notas}" oninput="setFormField('notas', this.value)" />
          
          <div id="form-error" class="md:col-span-7"></div> 
          
          <button class="w-full md:col-span-7 bg-blue-600 text-white font-semibold rounded-lg py-3 hover:bg-blue-700 transition transform hover:scale-[1.02] shadow-md" onclick="saveProducto()">${editing ? "üíæ Guardar cambios" : "‚ûï A√±adir producto"}</button>
        </div>` : "";
        
      document.getElementById("form-container").innerHTML = formHTML;
    }

    // Renderiza las pesta√±as de resumen, tabla y estad√≠sticas
    function render() {
      // C√°lculos de resumen
      const invertido = productos.reduce((acc, p) => acc + parseFloat(p.precioCompra || 0), 0);
      const vendidos = productos.filter(p => p.vendido).length;
      const beneficioTotal = productos.reduce((acc, p) => acc + ((parseFloat(p.precioVenta || 0) || 0) - parseFloat(p.precioCompra || 0)), 0);
      const stock = productos.filter(p => !p.vendido).length;
      const valorSinVender = productos.filter(p => !p.vendido).reduce((acc, p) => acc + parseFloat(p.valorVenta || 0), 0);
      
      const renderTabla = (lista, incluirPorcentaje = false) => {
        
        if (lista.length === 0) {
            // Fondo oscuro para mensaje vac√≠o
            return '<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-xl shadow">No hay productos registrados en esta lista. A√±ade uno para empezar.</p>';
        }

        return `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-gray-800 rounded-xl shadow-lg border border-gray-700">
            <thead class="bg-gray-700 text-gray-200">
              <tr>
                <th class="p-3 text-left">Producto</th>
                <th class="p-3 text-left">Fecha compra</th>
                <th class="p-3 text-right">Precio compra</th>
                <th class="p-3 text-right">Precio venta</th>
                <th class="p-3 text-left">Fecha venta</th>
                <th class="p-3 text-center">Vendido</th>
                <th class="p-3 text-right">Beneficio</th>
                ${incluirPorcentaje ? `<th class="p-3 text-right">% Beneficio</th>` : ""}
                <th class="p-3 text-left">Notas</th>
                <th class="p-3 text-center">Editar</th>
              </tr>
            </thead>
            <tbody>
              ${lista.map(p => {
                const compra = parseFloat(p.precioCompra || 0);
                const venta = parseFloat(p.precioVenta || 0);
                const beneficio = venta - compra;
                let porcentaje = 'N/A';
                if (p.vendido && compra !== 0) {
                  // C√°lculo de % de beneficio: (Beneficio / Coste) * 100
                  porcentaje = ((beneficio / compra) * 100).toFixed(1);
                }
                // Ajuste de colores de fila para Dark Mode
                const rowColor = p.vendido ? 'bg-green-900/40 hover:bg-green-900/70' : 'hover:bg-red-900/40';

                return `
                  <tr class="${rowColor} border-t border-gray-700 text-gray-300">
                    <td class="p-3">${p.nombre}</td>
                    <td class="p-3">${p.fecha || '-'}</td>
                    <td class="p-3 text-right text-gray-400">‚Ç¨ ${formatPriceDisplay(p.precioCompra)}</td>
                    <!-- Ajuste de texto de venta -->
                    <td class="p-3 text-right text-${p.vendido ? 'green-400' : 'red-400'} font-medium">${p.precioVenta ? '‚Ç¨ ' + formatPriceDisplay(p.precioVenta) : '-'}</td>
                    <td class="p-3">${p.fechaVenta || '-'}</td>
                    <td class="p-3 text-center">${p.vendido ? '‚úÖ S√≠' : '‚ùå No'}</td>
                    <!-- Ajuste de texto de beneficio -->
                    <td class="p-3 text-right font-semibold text-${beneficio >= 0 ? 'blue-400' : 'red-400'}">${beneficio.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                    ${ incluirPorcentaje ? `<td class="p-3 text-right">${porcentaje === 'N/A' ? 'N/A' : porcentaje + '%'}</td>` : '' }
                    <td class="p-3 text-sm text-gray-400 max-w-xs overflow-hidden text-ellipsis">${p.notas || '-'}</td>
                    <td class="p-3 text-center"><button class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full hover:bg-blue-600 transition shadow-sm" onclick='editProducto(${JSON.stringify(p)})'>Editar</button></td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>`;
      };
      
      const appContent = `
        <h1 class="text-4xl font-extrabold text-center text-white mb-8">üìà Reventa Tracker Cloud</h1>

        <!-- Controles de pesta√±a: AHORA LLAMAN A setTab() -->
        <div class="flex gap-4 justify-center p-2 rounded-xl bg-slate-800 shadow-inner">
          <button onclick="setTab('panel')" class="px-5 py-2 text-lg font-medium rounded-full transition ${tab === 'panel' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-300 hover:bg-slate-700'}">Panel</button>
          <button onclick="setTab('productos')" class="px-5 py-2 text-lg font-medium rounded-full transition ${tab === 'productos' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-300 hover:bg-slate-700'}">Mis Productos</button>
          <button onclick="setTab('estadisticas')" class="px-5 py-2 text-lg font-medium rounded-full transition ${tab === 'estadisticas' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-300 hover:bg-slate-700'}">Estad√≠sticas</button>
        </div>

        <!-- Muestra el ID de usuario para referencia -->
        <p class="text-sm text-center text-gray-500 mt-4">Usuario (ID An√≥nimo): ${userId}</p>

        <!-- Contenido de las pesta√±as -->
        ${tab === "panel" ? `
        <h2 class="text-2xl font-semibold text-gray-300 mt-6">Resumen del Inventario</h2>
        <!-- Tarjetas de resumen ajustadas para Dark Mode (bg-gray-800, text-400) -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
          <div class="bg-gray-800 shadow-md p-4 rounded-xl border-l-4 border-blue-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-400">Invertido</h2><p class="text-2xl font-bold text-blue-400">‚Ç¨ ${invertido.toFixed(2).replace('.', ',')}</p></div>
          <div class="bg-gray-800 shadow-md p-4 rounded-xl border-l-4 border-green-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-400">Vendidos</h2><p class="text-2xl font-bold text-green-400">${vendidos}</p></div>
          <div class="bg-gray-800 shadow-md p-4 rounded-xl border-l-4 border-purple-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-400">Beneficio total</h2><p class="text-2xl font-bold text-purple-400">‚Ç¨ ${beneficioTotal.toFixed(2).replace('.', ',')}</p></div>
          <div class="bg-gray-800 shadow-md p-4 rounded-xl border-l-4 border-red-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-400">Stock</h2><p class="text-2xl font-bold text-red-400">${stock}</p></div>
          <div class="bg-gray-800 shadow-md p-4 rounded-xl border-l-4 border-orange-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-400">Valor sin vender</h2><p class="text-2xl font-bold text-orange-400">‚Ç¨ ${valorSinVender.toFixed(2).replace('.', ',')}</p></div>
        </div>

        <h2 class="text-2xl font-semibold text-gray-300 mt-6">Inventario Completo</h2>
        <div class="mt-4">${renderTabla(productos)}</div>
        ` : ""}


        ${tab === "productos" ? `
          <h2 class="text-2xl font-semibold text-gray-300 mt-6">Detalle de Productos</h2>
          ${renderTabla(productos, true)}
        ` : ""}

        ${tab === "estadisticas" ? `
        <h2 class="text-2xl font-semibold text-gray-300 mt-6">Estad√≠sticas Clave</h2>
        <div class="space-y-4">
          ${productos.length > 0 ? (() => {
            // L√≥gica para encontrar el producto m√°s rentable (SOLO productos vendidos)
            const vendidosConBeneficio = productos
                .filter(p => p.vendido)
                .map(p => {
                    // Aseguramos que los valores sean n√∫meros antes de restar
                    const beneficio = (parseFloat(p.precioVenta || 0) - parseFloat(p.precioCompra || 0));
                    return { ...p, beneficio: beneficio };
                });
            
            let mejorProducto = null;
            if (vendidosConBeneficio.length > 0) {
                // Ordenar para encontrar el producto con el mayor beneficio individual
                mejorProducto = vendidosConBeneficio.sort((a, b) => b.beneficio - a.beneficio)[0];
            }

            return `
            <!-- Ajuste para Dark Mode -->
            <div class="bg-gray-800 p-6 shadow-md rounded-xl border-l-4 border-purple-500">
              <h2 class="text-xl font-medium text-purple-400">ü•á Producto con m√°s beneficio (Neto Individual)</h2>
              <p class="text-lg mt-1 font-semibold">${mejorProducto ? mejorProducto.nombre : 'No hay productos vendidos' } 
              ${mejorProducto ? `(Beneficio: ‚Ç¨ ${mejorProducto.beneficio.toFixed(2).replace('.', ',')})` : ''}
              </p>
            </div>
            
            <!-- Ajuste para Dark Mode -->
            <div class="bg-gray-800 p-6 shadow-md rounded-xl border-l-4 border-teal-500">
              <h2 class="text-xl font-medium text-teal-400">‚è±Ô∏è Velocidad de venta</h2>
              ${productos.filter(p => p.vendido && p.fecha && p.fechaVenta).length ? (() => {
                const vendidos = productos.filter(p => p.vendido && p.fecha && p.fechaVenta).map(p => {
                  // C√°lculo de d√≠as de diferencia
                  const dias = Math.ceil((new Date(p.fechaVenta) - new Date(p.fecha)) / 86400000);
                  return { ...p, dias };
                });
                const masRap = vendidos.reduce((a,b)=> a.dias<b.dias?a:b);
                const masLen = vendidos.reduce((a,b)=> a.dias>b.dias?a:b);
                return `<p class="mt-1 text-gray-300"><strong>üöÄ M√°s r√°pido:</strong> ${masRap.nombre} (${masRap.dias} d√≠as)</p><p class="text-gray-300"><strong>üê¢ M√°s lento:</strong> ${masLen.nombre} (${masLen.dias} d√≠as)</p>`;
              })() : '<p class="mt-1 text-gray-500">No hay datos suficientes de ventas con fecha de compra y venta.</p>'}
            </div>`;
          })() : '<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-xl shadow">A√±ade productos para ver las estad√≠sticas.</p>'}
        </div>` : ""}
      `;

      document.getElementById("app").innerHTML = appContent;
    }

    // =================================================================
    // INICIO DE LA APLICACI√ìN
    // =================================================================
    initializeFirebase();
    
    // =================================================================
    // EXPOSICI√ìN GLOBAL (NECESARIO PARA ONCLICK EN HTML)
    // =================================================================
    // Exponemos las funciones necesarias al objeto window para que los eventos onclick del HTML puedan acceder a ellas.
    window.setTab = setTab; 
    window.render = render;
    window.renderForm = renderForm;
    window.saveProducto = saveProducto;
    window.setFormField = setFormField;
    window.editProducto = editProducto;

  </script>
</body>
</html>
