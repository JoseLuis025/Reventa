<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reventa Tracker - Sincronizado en la Nube</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 1. INCLUIR LIBRER√çAS DE FIREBASE (Versiones UMD para HTML est√°tico) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    /* Estilo b√°sico para asegurar que Tailwind funcione y centrar la app */
    body {
        font-family: 'Inter', sans-serif;
    }
    /* Estilo para ocultar el formulario mientras se carga Firebase */
    #form-container { opacity: 0; transition: opacity 0.5s; }
    .loaded #form-container { opacity: 1; }
  </style>
</head>
<body class="bg-gray-100 p-6 rounded-xl">
  <div id="app" class="max-w-6xl mx-auto space-y-6"></div>
  <div id="form-container" class="max-w-6xl mx-auto"></div> 

  <script>
    // =================================================================
    // CONFIGURACI√ìN DE FIREBASE Y CONEXI√ìN
    // Esta configuraci√≥n usa las claves que proporcionaste:
    // =================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyDjTf3MR6Hn6G5igOQocjLb2cW6kogaeM4",
        authDomain: "reventa-de8be.firebaseapp.com",
        projectId: "reventa-de8be",
        storageBucket: "reventa-de8be.firebasestorage.app",
        messagingSenderId: "396010674100",
        appId: "1:396010674100:web:28532dafe6f223969404e1"
    };

    // Declaramos 'db' y 'COLLECTION_NAME' globalmente (fuera del try/catch)
    let db; 
    let COLLECTION_NAME = "productosReventa";

    // Inicializar Firebase y Firestore
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore(); // Ahora se asigna a la variable global 'db'
    } catch (error) {
        console.error("Error al inicializar Firebase: ", error);
        alert("Error de conexi√≥n a Firebase. Verifica que las claves son correctas y Firestore est√° habilitado.");
    }


    // =================================================================
    // ESTADO LOCAL DE LA APLICACI√ìN
    // =================================================================
    let productos = [];
    let tab = "panel";
    let editing = null;

    const emptyForm = { nombre: "", precioCompra: "", precioVenta: "", valorVenta: "", fecha: "", fechaVenta: "", notas: "" };
    let form = { ...emptyForm };
    
    // Funci√≥n para actualizar el formulario (sin llamar a render() para no perder el foco)
    function setFormField(field, value) {
      form[field] = value;
    }

    // Normalizar precios: permite coma/punto al escribir, guarda con punto
    function normalizePrice(priceString) {
      if (!priceString) return "";
      return priceString.toString().replace(/,/g, '.').replace(/[^\d.]/g, '');
    }

    // Formatea un n√∫mero para mostrarlo con coma como separador decimal (ej. 148,10)
    const formatPriceDisplay = (priceString) => {
        const num = parseFloat(priceString);
        if (isNaN(num)) return '-';
        return num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // =================================================================
    // L√ìGICA DE CARGA Y GUARDADO (USANDO FIRESTORE)
    // =================================================================

    // Funci√≥n principal para cargar datos desde Firestore
    async function loadProductos() {
      if (!db) return; // A√±adir verificaci√≥n por si la inicializaci√≥n fall√≥

      try {
        // 'db' y 'COLLECTION_NAME' ahora est√°n en el √°mbito correcto
        const snapshot = await db.collection(COLLECTION_NAME).get();
        
        // Mapeamos los documentos de Firestore al array local
        productos = snapshot.docs.map(doc => ({ 
          id: doc.id, // Guardamos el ID de Firestore para poder editar/eliminar
          ...doc.data(),
          // Aseguramos que los campos de precio sean cadenas o n√∫meros
          precioCompra: doc.data().precioCompra || "",
          precioVenta: doc.data().precioVenta || "",
          valorVenta: doc.data().valorVenta || ""
        }));

        // Una vez cargado, mostramos la interfaz y renderizamos
        document.body.classList.add('loaded');
        renderForm();
        render();

      } catch (error) {
        console.error("Error al cargar productos desde Firestore: ", error);
        // Podr√≠a ser un error de permisos o de conexi√≥n
        alert("Error al conectar con la base de datos. ¬øHas publicado las Reglas de Seguridad?");
      }
    }

    async function saveProducto() {
      if (!db) return; // A√±adir verificaci√≥n por si la inicializaci√≥n fall√≥

      // 1. Normalizar y validar
      const precioCompraNormalizado = normalizePrice(form.precioCompra);

      const productoToSave = {
        ...form,
        precioCompra: precioCompraNormalizado,
        precioVenta: normalizePrice(form.precioVenta),
        valorVenta: normalizePrice(form.valorVenta),
      };

      if (!productoToSave.nombre || isNaN(parseFloat(precioCompraNormalizado))) {
        alert("Debes rellenar el nombre y el precio de compra con un n√∫mero v√°lido.");
        return;
      }
      
      // Determinar si el producto est√° vendido
      const isVendido = !!productoToSave.precioVenta;
      const dataToSave = { ...productoToSave, vendido: isVendido, updatedAt: new Date() };

      try {
        if (editing) {
          // Si estamos editando, actualizamos el documento por su ID
          await db.collection(COLLECTION_NAME).doc(editing).update(dataToSave);
          editing = null;
        } else {
          // Si es un producto nuevo, lo a√±adimos
          await db.collection(COLLECTION_NAME).add(dataToSave);
        }

        // 2. Resetear el formulario y recargar los datos de la nube
        form = { ...emptyForm };
        await loadProductos(); // Esto actualiza la UI con los datos sincronizados
        renderForm(); 

      } catch (error) {
        console.error("Error al guardar producto en Firestore:", error);
        alert("Hubo un error al guardar los datos en la nube. Revisa la consola para m√°s detalles.");
      }
    }

    // Carga los datos de un producto en el formulario para editar
    function editProducto(p) {
      editing = p.id;
      // Usamos los valores tal como est√°n guardados 
      form = { ...p }; 
      renderForm(); 
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // =================================================================
    // RENDERIZADO DE LA UI
    // =================================================================

    // Funci√≥n para renderizar solo el formulario
    function renderForm() {
      const formHTML = tab === "panel" ? `
        <div id="resale-form" class="bg-white shadow-lg rounded-xl p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-4 mb-6 transition transform hover:scale-[1.01] duration-300">
          <input class="border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Producto" value="${form.nombre}" oninput="setFormField('nombre', this.value)" />
          <input class="border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Precio compra (‚Ç¨)" type="text" value="${form.precioCompra}" oninput="setFormField('precioCompra', this.value)" />
          <input class="border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Precio venta (‚Ç¨)" type="text" value="${form.precioVenta}" oninput="setFormField('precioVenta', this.value)" />
          <input class="border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Valor venta (‚Ç¨)" type="text" value="${form.valorVenta}" oninput="setFormField('valorVenta', this.value)" />
          <input class="border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Fecha compra" type="date" value="${form.fecha}" oninput="setFormField('fecha', this.value)" />
          <input class="border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Fecha venta" type="date" value="${form.fechaVenta}" oninput="setFormField('fechaVenta', this.value)" />
          <input class="border border-gray-300 p-2 rounded-lg md:col-span-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Notas" value="${form.notas}" oninput="setFormField('notas', this.value)" />

          <button class="w-full md:col-span-7 bg-blue-600 text-white font-semibold rounded-lg py-3 hover:bg-blue-700 transition transform hover:scale-[1.02] shadow-md" onclick="saveProducto()">${editing ? "üíæ Guardar cambios" : "‚ûï A√±adir producto"}</button>
        </div>` : "";
        
      document.getElementById("form-container").innerHTML = formHTML;
    }

    // Funci√≥n para renderizar la tabla y estad√≠sticas
    function render() {
      // Asegurar que los c√°lculos usen n√∫meros flotantes (los datos de Firestore son cadenas)
      const invertido = productos.reduce((acc, p) => acc + parseFloat(p.precioCompra || 0), 0);
      const vendidos = productos.filter(p => p.vendido).length;
      const beneficioTotal = productos.reduce((acc, p) => acc + ((parseFloat(p.precioVenta || 0) || 0) - parseFloat(p.precioCompra || 0)), 0);
      const stock = productos.filter(p => !p.vendido).length;
      const valorSinVender = productos.filter(p => !p.vendido).reduce((acc, p) => acc + parseFloat(p.valorVenta || 0), 0);
      
      const renderTabla = (lista, incluirPorcentaje = false) => {
        
        // Mensaje si no hay productos
        if (lista.length === 0) {
            return '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow">No hay productos registrados en esta lista. A√±ade uno para empezar.</p>';
        }

        return `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-xl shadow-lg border border-gray-200">
            <thead class="bg-gray-200">
              <tr>
                <th class="p-3 text-left">Producto</th>
                <th class="p-3 text-left">Fecha compra</th>
                <th class="p-3 text-right">Precio compra</th>
                <th class="p-3 text-right">Precio venta</th>
                <th class="p-3 text-left">Fecha venta</th>
                <th class="p-3 text-center">Vendido</th>
                <th class="p-3 text-right">Beneficio</th>
                ${incluirPorcentaje ? `<th class="p-3 text-right">% Beneficio</th>` : ""}
                <th class="p-3 text-left">Notas</th>
                <th class="p-3 text-center">Editar</th>
              </tr>
            </thead>
            <tbody>
              ${lista.map(p => {
                const compra = parseFloat(p.precioCompra || 0);
                const venta = parseFloat(p.precioVenta || 0);
                const beneficio = venta - compra;
                let porcentaje = 'N/A';
                if (p.vendido && compra !== 0) {
                  porcentaje = ((beneficio / compra) * 100).toFixed(1);
                }
                const rowColor = p.vendido ? 'bg-green-50 hover:bg-green-100' : 'hover:bg-red-50';

                return `
                  <tr class="${rowColor} border-t border-gray-100">
                    <td class="p-3">${p.nombre}</td>
                    <td class="p-3">${p.fecha || '-'}</td>
                    <td class="p-3 text-right text-gray-700">‚Ç¨ ${formatPriceDisplay(p.precioCompra)}</td>
                    <td class="p-3 text-right text-${p.vendido ? 'green' : 'red'}-600 font-medium">${p.precioVenta ? '‚Ç¨ ' + formatPriceDisplay(p.precioVenta) : '-'}</td>
                    <td class="p-3">${p.fechaVenta || '-'}</td>
                    <td class="p-3 text-center">${p.vendido ? '‚úÖ S√≠' : '‚ùå No'}</td>
                    <td class="p-3 text-right font-semibold text-${beneficio >= 0 ? 'blue' : 'red'}-700">${beneficio.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                    ${ incluirPorcentaje ? `<td class="p-3 text-right">${porcentaje === 'N/A' ? 'N/A' : porcentaje + '%'}</td>` : '' }
                    <td class="p-3 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis">${p.notas || '-'}</td>
                    <td class="p-3 text-center"><button class="bg-blue-500 text-white text-sm px-3 py-1 rounded-full hover:bg-blue-600 transition shadow-sm" onclick='editProducto(${JSON.stringify(p)})'>Editar</button></td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>`;
      };
      
      const appContent = `
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">üìà Reventa Tracker Cloud</h1>

        <!-- Controles de pesta√±a -->
        <div class="flex gap-4 justify-center p-2 rounded-xl bg-white shadow-inner">
          <button onclick="tab='panel'; render(); renderForm()" class="px-5 py-2 text-lg font-medium rounded-full transition ${tab === 'panel' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">Panel</button>
          <button onclick="tab='productos'; render(); renderForm()" class="px-5 py-2 text-lg font-medium rounded-full transition ${tab === 'productos' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">Mis Productos</button>
          <button onclick="tab='estadisticas'; render(); renderForm()" class="px-5 py-2 text-lg font-medium rounded-full transition ${tab === 'estadisticas' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">Estad√≠sticas</button>
        </div>

        <!-- Contenido de las pesta√±as -->
        ${tab === "panel" ? `
        <h2 class="text-2xl font-semibold text-gray-700 mt-6">Resumen del Inventario</h2>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
          <div class="bg-white shadow-md p-4 rounded-xl border-l-4 border-blue-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-500">Invertido</h2><p class="text-2xl font-bold text-blue-700">‚Ç¨ ${invertido.toFixed(2).replace('.', ',')}</p></div>
          <div class="bg-white shadow-md p-4 rounded-xl border-l-4 border-green-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-500">Vendidos</h2><p class="text-2xl font-bold text-green-700">${vendidos}</p></div>
          <div class="bg-white shadow-md p-4 rounded-xl border-l-4 border-purple-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-500">Beneficio total</h2><p class="text-2xl font-bold text-purple-700">‚Ç¨ ${beneficioTotal.toFixed(2).replace('.', ',')}</p></div>
          <div class="bg-white shadow-md p-4 rounded-xl border-l-4 border-red-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-500">Stock</h2><p class="text-2xl font-bold text-red-700">${stock}</p></div>
          <div class="bg-white shadow-md p-4 rounded-xl border-l-4 border-orange-500 transition hover:shadow-lg"><h2 class="text-lg text-gray-500">Valor sin vender</h2><p class="text-2xl font-bold text-orange-700">‚Ç¨ ${valorSinVender.toFixed(2).replace('.', ',')}</p></div>
        </div>

        <h2 class="text-2xl font-semibold text-gray-700 mt-6">Inventario Completo</h2>
        <div class="mt-4">${renderTabla(productos)}</div>
        ` : ""}


        ${tab === "productos" ? `
          <h2 class="text-2xl font-semibold text-gray-700 mt-6">Detalle de Productos</h2>
          ${renderTabla(productos, true)}
        ` : ""}

        ${tab === "estadisticas" ? `
        <h2 class="text-2xl font-semibold text-gray-700 mt-6">Estad√≠sticas Clave</h2>
        <div class="space-y-4">
          ${productos.length > 0 ? `
          <div class="bg-white p-6 shadow-md rounded-xl border-l-4 border-purple-500">
            <h2 class="text-xl font-medium text-purple-700">ü•á Producto con m√°s beneficio (Neto)</h2>
            <p class="text-lg mt-1 font-semibold">${productos.sort((a,b)=>((parseFloat(b.precioVenta)||0)-parseFloat(b.precioCompra))-((parseFloat(a.precioVenta)||0)-parseFloat(a.precioCompra)))[0].nombre} (Beneficio: ‚Ç¨ ${beneficioTotal.toFixed(2).replace('.', ',')})</p>
          </div>

          <div class="bg-white p-6 shadow-md rounded-xl border-l-4 border-teal-500">
            <h2 class="text-xl font-medium text-teal-700">‚è±Ô∏è Velocidad de venta</h2>
            ${productos.filter(p => p.vendido && p.fecha && p.fechaVenta).length ? (() => {
              const vendidos = productos.filter(p => p.vendido && p.fecha && p.fechaVenta).map(p => {
                const dias = Math.ceil((new Date(p.fechaVenta) - new Date(p.fecha)) / 86400000);
                return { ...p, dias };
              });
              const masRap = vendidos.reduce((a,b)=> a.dias<b.dias?a:b);
              const masLen = vendidos.reduce((a,b)=> a.dias>b.dias?a:b);
              return `<p class="mt-1"><strong>üöÄ M√°s r√°pido:</strong> ${masRap.nombre} (${masRap.dias} d√≠as)</p><p><strong>üê¢ M√°s lento:</strong> ${masLen.nombre} (${masLen.dias} d√≠as)</p>`;
            })() : '<p class="mt-1 text-gray-500">No hay datos suficientes de ventas con fecha de compra y venta.</p>'}
          </div>
          ` : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow">A√±ade productos para ver las estad√≠sticas.</p>'}
        </div>` : ""}
      `;

      document.getElementById("app").innerHTML = appContent;
    }

    // INICIO DE LA APLICACI√ìN: Cargar datos de Firebase al inicio
    // Solo inicia si Firebase se inicializ√≥ correctamente
    if (typeof firebase !== 'undefined') {
        loadProductos();
    }
  </script>
</body>
</html>
