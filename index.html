<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reventa Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/framer-motion/11.0.3/framer-motion.umd.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div id="app" class="max-w-6xl mx-auto space-y-6"></div>
  <div id="form-container" class="max-w-6xl mx-auto"></div> 

  <script>
    // Estado
    let productos = JSON.parse(localStorage.getItem("productosReventa")) || [];
    let tab = "panel";
    let editing = null;

    const emptyForm = { nombre: "", precioCompra: "", precioVenta: "", valorVenta: "", fecha: "", fechaVenta: "", notas: "" };
    let form = { ...emptyForm };

    function saveLS() {
      localStorage.setItem("productosReventa", JSON.stringify(productos));
    }

    // AHORA: Esta funci√≥n SOLO actualiza el estado. NO llama a render().
    function setFormField(field, value) {
      form[field] = value;
      // Ya NO llamamos a render(), lo que soluciona la p√©rdida de foco.
      // El navegador se encargar√° de mostrar lo que se escribe en el input.
    }

    // Funci√≥n auxiliar para normalizar la entrada de precios (coma a punto)
    function normalizePrice(priceString) {
      if (!priceString) return "";
      // Permite n√∫meros, comas y puntos. Luego reemplaza comas por puntos.
      return priceString.toString().replace(/,/g, '.').replace(/[^\d.]/g, '');
    }

    function saveProducto() {
      // 1. Validar y normalizar los datos del formulario antes de guardar.
      const productoToSave = {
        ...form,
        // Convertir a cadena con punto para guardarla de forma consistente
        precioCompra: normalizePrice(form.precioCompra),
        precioVenta: normalizePrice(form.precioVenta),
        valorVenta: normalizePrice(form.valorVenta),
      };

      if (!productoToSave.nombre || !productoToSave.precioCompra || isNaN(parseFloat(productoToSave.precioCompra))) return;

      // 2. Guardar o actualizar el producto.
      if (editing) {
        productos = productos.map(p => p.id === editing ? { ...p, ...productoToSave, vendido: !!productoToSave.precioVenta } : p);
        editing = null;
      } else {
        productos.push({ ...productoToSave, id: Date.now(), vendido: !!productoToSave.precioVenta });
      }

      // 3. Resetear el formulario, guardar en LS y re-renderizar.
      form = { ...emptyForm };
      saveLS();
      // Re-renderizamos toda la UI despu√©s de guardar, no durante la escritura.
      renderForm(); 
      render(); 
    }

    function editProducto(p) {
      editing = p.id;
      // Usamos el valor guardado (con punto) en el formulario de edici√≥n.
      form = { ...p }; 
      renderForm(); 
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Formatea un n√∫mero para mostrarlo con coma como separador decimal (ej. 148,10)
    const formatPriceDisplay = (priceString) => {
        const num = parseFloat(priceString);
        if (isNaN(num)) return '-';
        // Usamos es-ES para el formato con coma
        return num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    function renderTabla(lista, incluirPorcentaje = false) {
      return `
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-xl shadow">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2 text-left">Producto</th>
              <th class="p-2 text-left">Fecha compra</th>
              <th class="p-2 text-right">Precio compra</th>
              <th class="p-2 text-right">Precio venta</th>
              <th class="p-2 text-left">Fecha venta</th>
              <th class="p-2">Vendido</th>
              <th class="p-2 text-right">Beneficio</th>
              ${incluirPorcentaje ? `<th class="p-2 text-right">% Beneficio</th>` : ""}
              <th class="p-2 text-left">Notas</th>
              <th class="p-2">Editar</th>
            </tr>
          </thead>
          <tbody>
            ${lista.map(p => {
              const compra = parseFloat(p.precioCompra || 0);
              const venta = parseFloat(p.precioVenta || 0);
              const beneficio = venta - compra;
              let porcentaje = 'N/A';
              if (p.vendido && compra !== 0) {
                 porcentaje = ((beneficio / compra) * 100).toFixed(1);
              }

              return `
                <tr class="${p.vendido ? 'bg-green-100' : 'hover:bg-red-50'}">
                  <td class="border p-2">${p.nombre}</td>
                  <td class="border p-2">${p.fecha || '-'}</td>
                  <td class="border p-2 text-right">‚Ç¨ ${formatPriceDisplay(p.precioCompra)}</td>
                  <td class="border p-2 text-right">${p.precioVenta ? '‚Ç¨ ' + formatPriceDisplay(p.precioVenta) : '-'}</td>
                  <td class="border p-2">${p.fechaVenta || '-'}</td>
                  <td class="border p-2 text-center">${p.vendido ? 'S√≠' : 'No'}</td>
                  <td class="border p-2 text-right">${beneficio.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                  ${ incluirPorcentaje ? `<td class="border p-2 text-right">${porcentaje === 'N/A' ? 'N/A' : porcentaje + '%'}</td>` : '' }
                  <td class="border p-2">${p.notas || '-'}</td>
                  <td class="border p-2 text-center"><button class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition" onclick='editProducto(${JSON.stringify(p)})'>Editar</button></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>`;
    }

    // Funci√≥n para renderizar solo el formulario
    function renderForm() {
      // Usamos los valores actuales del estado 'form' para precargar los inputs.
      const formHTML = tab === "panel" ? `
        <div id="resale-form" class="bg-white shadow rounded-xl p-4 grid grid-cols-1 md:grid-cols-7 gap-4 mb-6">
          <input class="border p-2 rounded" placeholder="Producto" value="${form.nombre}" oninput="setFormField('nombre', this.value)" />
          
          <input class="border p-2 rounded" placeholder="Precio compra (‚Ç¨)" type="text" value="${form.precioCompra}" oninput="setFormField('precioCompra', this.value)" />
          <input class="border p-2 rounded" placeholder="Precio venta (‚Ç¨)" type="text" value="${form.precioVenta}" oninput="setFormField('precioVenta', this.value)" />
          <input class="border p-2 rounded" placeholder="Valor venta (‚Ç¨)" type="text" value="${form.valorVenta}" oninput="setFormField('valorVenta', this.value)" />
          
          <input class="border p-2 rounded" placeholder="Fecha compra" type="date" value="${form.fecha}" oninput="setFormField('fecha', this.value)" />
          <input class="border p-2 rounded" placeholder="Fecha venta" type="date" value="${form.fechaVenta}" oninput="setFormField('fechaVenta', this.value)" />
          <input class="border p-2 rounded md:col-span-2" placeholder="Notas" value="${form.notas}" oninput="setFormField('notas', this.value)" />

          <button class="w-full md:col-span-7 bg-blue-600 text-white rounded py-2 hover:bg-blue-700 transition" onclick="saveProducto()">${editing ? "Guardar cambios" : "A√±adir producto"}</button>
        </div>` : "";
        
      document.getElementById("form-container").innerHTML = formHTML;
    }


    function render() {
      // C√°lculos (usando parseFloat y manejo de valores vac√≠os)
      const invertido = productos.reduce((acc, p) => acc + parseFloat(p.precioCompra || 0), 0);
      const vendidos = productos.filter(p => p.vendido).length;
      const beneficioTotal = productos.reduce((acc, p) => acc + ((parseFloat(p.precioVenta || 0) || 0) - parseFloat(p.precioCompra || 0)), 0);
      const stock = productos.filter(p => !p.vendido).length;
      const valorSinVender = productos.filter(p => !p.vendido).reduce((acc, p) => acc + parseFloat(p.valorVenta || 0), 0);
      
      const appContent = `
        <h1 class="text-3xl font-bold text-center">üìà Seguimiento de Reventa</h1>

        <div class="flex gap-4 justify-center mt-4">
          <button onclick="tab='panel'; render(); renderForm()" class="px-4 py-2 ${tab === 'panel' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} rounded transition">Panel</button>
          <button onclick="tab='productos'; render(); renderForm()" class="px-4 py-2 ${tab === 'productos' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} rounded transition">Mis Productos</button>
          <button onclick="tab='estadisticas'; render(); renderForm()" class="px-4 py-2 ${tab === 'estadisticas' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} rounded transition">Estad√≠sticas</button>
        </div>

        ${tab === "panel" ? `
        <h2 class="text-2xl font-semibold mt-6">Resumen del Inventario</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 mt-4">
          <div class="bg-white shadow p-4 rounded border-l-4 border-blue-500"><h2 class="text-xl text-gray-600">Invertido</h2><p class="text-2xl font-bold">‚Ç¨ ${invertido.toFixed(2).replace('.', ',')}</p></div>
          <div class="bg-white shadow p-4 rounded border-l-4 border-green-500"><h2 class="text-xl text-gray-600">Vendidos</h2><p class="text-2xl font-bold">${vendidos}</p></div>
          <div class="bg-white shadow p-4 rounded border-l-4 border-purple-500"><h2 class="text-xl text-gray-600">Beneficio total</h2><p class="text-2xl font-bold">‚Ç¨ ${beneficioTotal.toFixed(2).replace('.', ',')}</p></div>
          <div class="bg-white shadow p-4 rounded border-l-4 border-red-500"><h2 class="text-xl text-gray-600">Stock</h2><p class="text-2xl font-bold">${stock}</p></div>
          <div class="bg-white shadow p-4 rounded border-l-4 border-orange-500"><h2 class="text-xl text-gray-600">Valor sin vender</h2><p class="text-2xl font-bold">‚Ç¨ ${valorSinVender.toFixed(2).replace('.', ',')}</p></div>
        </div>

        <h2 class="text-2xl font-semibold mt-6">Inventario Completo</h2>
        <div class="mt-4">${renderTabla(productos)}</div>
        ` : ""}


        ${tab === "productos" ? `
          <h2 class="text-2xl font-semibold mt-6">Detalle de Productos (con % Beneficio)</h2>
          ${renderTabla(productos, true)}
        ` : ""}

        ${tab === "estadisticas" ? `
        <h2 class="text-2xl font-semibold mt-6">Estad√≠sticas Clave</h2>
        <div class="space-y-4">
          <div class="bg-white p-4 shadow rounded border-l-4 border-purple-500">
            <h2 class="text-xl font-medium">ü•á Producto con m√°s beneficio</h2>
            <p class="text-lg mt-1">${productos.length ? productos.sort((a,b)=>((parseFloat(b.precioVenta)||0)-parseFloat(b.precioCompra))-((parseFloat(a.precioVenta)||0)-parseFloat(a.precioCompra)))[0].nombre : 'No hay productos registrados'}</p>
          </div>

          <div class="bg-white p-4 shadow rounded border-l-4 border-teal-500">
            <h2 class="text-xl font-medium">‚è±Ô∏è Velocidad de venta</h2>
            ${productos.filter(p => p.vendido && p.fecha && p.fechaVenta).length ? (() => {
              const vendidos = productos.filter(p => p.vendido && p.fecha && p.fechaVenta).map(p => {
                const dias = Math.ceil((new Date(p.fechaVenta) - new Date(p.fecha)) / 86400000);
                return { ...p, dias };
              });
              const masRap = vendidos.reduce((a,b)=> a.dias<b.dias?a:b);
              const masLen = vendidos.reduce((a,b)=> a.dias>b.dias?a:b);
              return `<p class="mt-1"><strong>M√°s r√°pido:</strong> ${masRap.nombre} (${masRap.dias} d√≠as)</p><p><strong>M√°s lento:</strong> ${masLen.nombre} (${masLen.dias} d√≠as)</p>`;
            })() : '<p class="mt-1">No hay datos suficientes de ventas con fecha de compra y venta.</p>'}
          </div>
        </div>` : ""}
      `;

      document.getElementById("app").innerHTML = appContent;
    }

    renderForm(); 
    render();
  </script>
</body>
</html>
