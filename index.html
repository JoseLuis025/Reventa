<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reventa Tracker - Cloud</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    #form-container { opacity: 0; transition: opacity 0.5s; }
    .loaded #form-container { opacity: 1; }
  </style>
</head>

<body class="bg-slate-900 p-6 rounded-xl text-gray-100">
  <div id="app" class="max-w-6xl mx-auto space-y-6"></div>
  <div id="form-container" class="max-w-6xl mx-auto"></div> 

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, doc, updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDjTf3MR6Hn6G5igOQocjLb2cW6kogaeM4",
        authDomain: "reventa-de8be.firebaseapp.com",
        projectId: "reventa-de8be",
        storageBucket: "reventa-de8be.firebasestorage.app",
        messagingSenderId: "396010674100",
        appId: "1:396010674100:web:28532dafe6f223969404e1"
    };

    let db; 
    let COLLECTION_NAME = "productosReventa";

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch (error) {
        console.error("Error al inicializar Firebase: ", error);
    }

    let productos = [];
    let tab = "panel";
    let editing = null;

    const emptyForm = { nombre: "", precioCompra: "", precioVenta: "", valorVenta: "", fecha: "", fechaVenta: "", notas: "" };
    let form = { ...emptyForm };

    function setFormField(field, value) { form[field] = value; }
    function setTab(newTab) { tab = newTab; editing = null; form = { ...emptyForm }; renderForm(); render(); }

    function normalizePrice(priceString) {
      if (!priceString) return "";
      return priceString.toString().replace(/,/g, '.').replace(/[^\d.]/g, '');
    }

    const formatPriceDisplay = (priceString) => {
        const num = parseFloat(priceString);
        if (isNaN(num)) return '-';
        return num.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    function loadProductos() {
      if (!db) return; 
      try {
        const colRef = collection(db, COLLECTION_NAME);

        onSnapshot(colRef, (snapshot) => {
            productos = snapshot.docs.map(doc => ({ 
              id: doc.id, 
              ...doc.data(),
              precioCompra: doc.data().precioCompra || "",
              precioVenta: doc.data().precioVenta || "",
              valorVenta: doc.data().valorVenta || ""
            }));

            document.body.classList.add('loaded');
            renderForm();
            render();
        });
      } catch (error) {
        console.error("Error al iniciar snapshot: ", error);
      }
    }

    async function saveProducto() {
      if (!db) return;

      const precioCompraNormalizado = normalizePrice(form.precioCompra);

      const productoToSave = {
        ...form,
        precioCompra: precioCompraNormalizado,
        precioVenta: normalizePrice(form.precioVenta),
        valorVenta: normalizePrice(form.valorVenta),
      };

      if (!productoToSave.nombre || isNaN(parseFloat(precioCompraNormalizado))) {
        document.getElementById('form-error').innerHTML =
          '<div class="text-red-400 font-medium">‚ùå Debes rellenar el nombre y el precio de compra.</div>';
        return;
      }
      
      document.getElementById('form-error').innerHTML = '';
      
      const isVendido = !!productoToSave.precioVenta;
      const dataToSave = { 
        ...productoToSave,
        vendido: isVendido,
        updatedAt: serverTimestamp()
      };

      try {
        if (editing) {
          const docRef = doc(db, COLLECTION_NAME, editing);
          await updateDoc(docRef, dataToSave);
        } else {
          await addDoc(collection(db, COLLECTION_NAME), dataToSave);
        }

        form = { ...emptyForm };
        editing = null; 
        renderForm(); 

      } catch (error) {
        console.error("Error al guardar:", error);
      }
    }

    function editProducto(p) {
      editing = p.id;
      form = { ...p };
      renderForm();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function renderForm() {
      const inputClasses = "border border-gray-700 p-2 rounded-lg bg-slate-700 text-white";

      const formHTML = tab === "panel" ? `
        <div id="resale-form" class="bg-gray-800 rounded-xl p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-4 mb-3">
          <input class="${inputClasses}" placeholder="Producto" value="${form.nombre}" oninput="setFormField('nombre', this.value)" />
          <input class="${inputClasses}" placeholder="Precio compra (‚Ç¨)" value="${form.precioCompra}" oninput="setFormField('precioCompra', this.value)" />
          <input class="${inputClasses}" placeholder="Precio venta (‚Ç¨)" value="${form.precioVenta}" oninput="setFormField('precioVenta', this.value)" />
          <input class="${inputClasses}" placeholder="Valor venta (‚Ç¨)" value="${form.valorVenta}" oninput="setFormField('valorVenta', this.value)" />
          <input class="${inputClasses}" type="date" placeholder="Fecha compra" value="${form.fecha}" oninput="setFormField('fecha', this.value)" />
          <input class="${inputClasses}" type="date" placeholder="Fecha venta" value="${form.fechaVenta}" oninput="setFormField('fechaVenta', this.value)" />
          <input class="${inputClasses} md:col-span-2" placeholder="Notas" value="${form.notas}" oninput="setFormField('notas', this.value)" />
          
          <div id="form-error" class="md:col-span-7"></div>

          <button class="w-full md:col-span-7 bg-blue-600 text-white font-semibold rounded-lg py-3" onclick="saveProducto()">
            ${editing ? "üíæ Guardar cambios" : "‚ûï A√±adir producto"}
          </button>
        </div>` : "";

      document.getElementById("form-container").innerHTML = formHTML;
    }

    function renderProductos() {
      if (productos.length === 0) {
        return `<p class="text-gray-400 text-center mt-8">No hay productos.</p>`;
      }

      return `
        <div class="mt-6">
          ${productos.map(p => `
            <div class="bg-gray-800 p-4 rounded-xl mb-3 border border-gray-700">
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="text-xl font-bold text-white">${p.nombre}</h3>
                  <p class="text-gray-400 text-sm">Comprado: ‚Ç¨${formatPriceDisplay(p.precioCompra)}</p>
                  <p class="text-gray-400 text-sm">Vendido: ${p.precioVenta ? "‚Ç¨"+formatPriceDisplay(p.precioVenta) : "‚õî No"}</p>
                </div>
                <button onclick="editProducto(${JSON.stringify(p)})" class="bg-blue-600 px-4 py-2 rounded-lg">‚úè Editar</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderEstadisticas() {
      const total = productos.length;
      const vendidos = productos.filter(p => p.vendido).length;
      const pendientes = total - vendidos;

      return `
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">

          <div class="bg-gray-800 p-6 rounded-xl border-l-4 border-blue-500">
            <h3 class="text-lg text-gray-400">Total productos</h3>
            <p class="text-3xl font-bold">${total}</p>
          </div>

          <div class="bg-gray-800 p-6 rounded-xl border-l-4 border-green-500">
            <h3 class="text-lg text-gray-400">Vendidos</h3>
            <p class="text-3xl font-bold">${vendidos}</p>
          </div>

          <div class="bg-gray-800 p-6 rounded-xl border-l-4 border-yellow-500">
            <h3 class="text-lg text-gray-400">Pendientes</h3>
            <p class="text-3xl font-bold">${pendientes}</p>
          </div>

        </div>
      `;
    }

    function render() {

      const invertido = productos.reduce((a,p)=>a+parseFloat(p.precioCompra||0),0);
      const vendidos = productos.filter(p=>p.vendido).length;
      const beneficioTotal = productos.reduce((a,p)=>a+((parseFloat(p.precioVenta||0)-parseFloat(p.precioCompra||0))||0),0);

      const appContent = `
        <h1 class="text-4xl font-extrabold text-center text-white mb-8">üìà Reventa Tracker Cloud</h1>

        <div class="flex gap-4 justify-center p-2 bg-slate-800 rounded-xl">
          <button onclick="setTab('panel')" class="px-5 py-2 rounded-full ${tab==='panel'?'bg-blue-600 text-white':'text-gray-300'}">Panel</button>
          <button onclick="setTab('productos')" class="px-5 py-2 rounded-full ${tab==='productos'?'bg-blue-600 text-white':'text-gray-300'}">Mis Productos</button>
          <button onclick="setTab('estadisticas')" class="px-5 py-2 rounded-full ${tab==='estadisticas'?'bg-blue-600 text-white':'text-gray-300'}">Estad√≠sticas</button>
        </div>

        ${
          tab==="panel"
          ? `
              <h2 class="text-2xl font-semibold text-gray-300 mt-6">Resumen</h2>
              <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-blue-500">
                  <h2 class="text-lg text-gray-400">Invertido</h2>
                  <p class="text-2xl font-bold text-blue-400">‚Ç¨ ${invertido.toFixed(2)}</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-green-500">
                  <h2 class="text-lg text-gray-400">Vendidos</h2>
                  <p class="text-2xl font-bold text-green-400">${vendidos}</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-purple-500">
                  <h2 class="text-lg text-gray-400">Beneficio total</h2>
                  <p class="text-2xl font-bold text-purple-400">‚Ç¨ ${beneficioTotal.toFixed(2)}</p>
                </div>
              </div>
            `
          : tab==="productos"
          ? renderProductos()
          : renderEstadisticas()
        }
      `;

      document.getElementById("app").innerHTML = appContent;
    }

    loadProductos();

    window.setTab = setTab;
    window.render = render;
    window.renderForm = renderForm;
    window.saveProducto = saveProducto;
    window.setFormField = setFormField;
    window.editProducto = editProducto;

  </script>
</body>
</html>
